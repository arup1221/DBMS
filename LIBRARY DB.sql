CREATE DATABASE LIBRARY;
USE LIBRARY;

CREATE TABLE PUBLISHER
(
	NAME VARCHAR(15),
    ADDRESS VARCHAR(25),
    PHONE CHAR(10),
    CONSTRAINT PK_PN PRIMARY KEY(NAME)
);

CREATE TABLE LIBRARY_PROGRAMME
(
	PROGRAMME_ID CHAR(5),
    PROGRAMME_NAME VARCHAR(15),
    ADDRESS VARCHAR(25),
    CONSTRAINT PK_ID PRIMARY KEY(PROGRAMME_ID)
    );
    
CREATE TABLE BOOK
(
	BOOK_ID CHAR(5),
    TITLE VARCHAR(25),
    PUBLISHER_NAME VARCHAR(15),
    PUBLISHER_YEAR INTEGER,
    CONSTRAINT PK_BID PRIMARY KEY(BOOK_ID),
    CONSTRAINT FK_N FOREIGN KEY(PUBLISHER_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE
);

CREATE TABLE BOOK_AUTHORS
(
	BOOK_ID CHAR(5),
    AUTHOR_NAME VARCHAR(25),
    CONSTRAINT FK_B FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE
    );
    
CREATE TABLE BOOK_COPIES
(
	BOOK_ID CHAR(5),
    PROGRAMME_ID CHAR(5),
    NO_OF_COPIES CHAR(2),
    CONSTRAINT CPK_BBI PRIMARY KEY(BOOK_ID,PROGRAMME_ID),
    CONSTRAINT FK_BI FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    CONSTRAINT FK_I FOREIGN KEY(PROGRAMME_ID) REFERENCES LIBRARY_PROGRAMME(PROGRAMME_ID) ON DELETE CASCADE
);

CREATE TABLE BOOK_LENDING
(
	BOOK_ID CHAR(5),
    PROGRAMME_ID CHAR(5),
    CARD_NO CHAR(3),
    DATE_OUT DATE,
    DUE_DATE DATE,
    CONSTRAINT CPK_BBC PRIMARY KEY(BOOK_ID,PROGRAMME_ID,CARD_NO),
    CONSTRAINT FK_A FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    CONSTRAINT FK_C FOREIGN KEY(PROGRAMME_ID) REFERENCES LIBRARY_PROGRAMME(PROGRAMME_ID) ON DELETE CASCADE
);

SHOW TABLES;

INSERT INTO PUBLISHER
(NAME,ADDRESS,PHONE)
VALUES
("PHI","PUNE,INDIA","9080706050"),
("PEARSON","MUMBAI,INDIA","8080707060"),
("MCGRAWHILL","HOUSTIN,USA","1020707070"),
("WILEY","CALIFORNIA,USA","1108080808"),
("SSI","FLORIDA","1208080909"),
("SP","BANGALORE,INDIA","9090909080");

SELECT * FROM PUBLISHER;

INSERT INTO LIBRARY_PROGRAMME VALUES('1000','MVIT','H-HALLI');
INSERT INTO LIBRARY_PROGRAMME VALUES('2000','SVIT','DODDABALLAPUR');
INSERT INTO LIBRARY_PROGRAMME VALUES('3000','BMSIT','AVANAHALLI');
INSERT INTO LIBRARY_PROGRAMME VALUES('4000','SVCE','VIDYANAGAR');
INSERT INTO LIBRARY_PROGRAMME VALUES('5000','MSCE','CHIKKAJALA');
INSERT INTO LIBRARY_PROGRAMME VALUES('6000','NMIT','YELAHANKA');

SELECT * FROM LIBRARY_PROGRAMME;

ALTER TABLE BOOK
RENAME COLUMN PUBLISHER_YEAR to PUB_YEAR;

ALTER TABLE PUBLISHER
MODIFY ADDRESS VARCHAR(25);

INSERT INTO BOOK
(BOOK_ID,TITLE,PUBLISHER_NAME,PUB_YEAR)
VALUES
('1111','FUNDAMENTALS OF DATABASE','PHI',2009),
('2222','BASICS OF LOGIC DESIGN','PEARSON',2009),
('3333','DATA STRUCTURES','MCGRAWHILL',2015),
('4444','ARTIFICIAL INTELLIGENCE','WILEY',2017),
('5555','PROGRAMMING SKILLS','SSI',2014),
('6666','DESIGN OF ALGORITHMS','SP',2013);

INSERT INTO BOOK_AUTHORS
(BOOK_ID,AUTHOR_NAME)
VALUES
('1111','NAVATHE'),
('2222','GODSE'),
('3333','SAHANI'),
('4444','RITCHIE KNIGHT'),
('5555','BALAGURUSWAMY'),
('6666','COREMEN');

INSERT INTO BOOK_COPIES
(BOOK_ID,PROGRAMME_ID,NO_OF_COPIES)
VALUES
('1111','1000','10'),
('2222','2000','5'),
('3333','3000','7'),
('4444','4000','9'),
('5555','5000','6'),
('6666','6000','12'),
('2222','1000','15');

-- INSERT INTO BOOK_LENDING
-- (BOOK_ID,PROGRAMME_ID,CARD_NO,DATE_OUT,DUE_DATE)
-- VALUES
-- ('1111','1000','10','15-FEB-17','15-JUN-17'),
-- ('2222','2000','10','10-MAR-17','15-AUG-17'),
-- ('3333','3000','10','15-APR-17','15-SEP-17'),
-- ('4444','4000','10','10-JUN-17','15-NOV-17'),
-- ('5555','5000','20','15-FEB-17','15-JUN-17'),
-- ('6666','6000','30','10-MAR-17','15-AUG-17'),
-- ('5555','5000','10','15-JAN-16','15-JUN-16');

INSERT INTO BOOK_LENDING
(BOOK_ID, PROGRAMME_ID, CARD_NO, DATE_OUT, DUE_DATE)
VALUES
('1111', '1000', '10', '2017-02-15', '2017-06-15'),
('2222', '2000', '10', '2017-03-10', '2017-08-15'),
('3333', '3000', '10', '2017-04-15', '2017-09-15'),
('4444', '4000', '10', '2017-06-10', '2017-11-15'),
('5555', '5000', '20', '2017-02-15', '2017-06-15'),
('6666', '6000', '30', '2017-03-10', '2017-08-15'),
('5555', '5000', '10', '2016-01-15', '2016-06-15');

SELECT * FROM BOOK_LENDING;
 


SELECT C.PROGRAMME_ID,L.PROGRAMME_NAME,B.BOOK_ID,B.TITLE,B.PUBLISHER_NAME,B.PUB_YEAR,A.AUTHOR_NAME,C.NO_OF_COPIES
FROM BOOK B,BOOK_AUTHORS A,LIBRARY_PROGRAMME L,BOOK_COPIES C 
WHERE B.BOOK_ID=A.BOOK_ID AND
B.BOOK_ID=C.BOOK_ID AND 
L.PROGRAMME_ID=C.PROGRAMME_ID AND 
(C.PROGRAMME_ID,C.BOOK_ID) IN 
(SELECT 
PROGRAMME_ID,BOOK_ID FROM 
BOOK_COPIES
GROUP BY PROGRAMME_ID,BOOK_ID);



SELECT * FROM BOOK_LENDING
WHERE DATE_OUT BETWEEN '2017-01-01' AND '2017-06-30' AND CARD_NO 
IN
(SELECT CARD_NO 
FROM BOOK_LENDING 
GROUP BY CARD_NO
HAVING COUNT(CARD_NO)>3);


DELETE FROM BOOK WHERE BOOK_ID=5555;
SELECT * FROM BOOK;


CREATE VIEW YEAR AS SELECT PUB_YEAR FROM BOOK;
SELECT * FROM YEAR;



CREATE VIEW ALL_BOOK AS
SELECT 
B.BOOK_ID,B.TITLE,C.NO_OF_COPIES,L.PROGRAMME_NAME
FROM BOOK B,BOOK_COPIES C,LIBRARY_PROGRAMME L
WHERE B.BOOK_ID=C.BOOK_ID 
AND 
L.PROGRAMME_ID=C.PROGRAMME_ID; 

SELECT * FROM ALL_BOOK;
